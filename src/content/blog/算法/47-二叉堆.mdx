---
title: äºŒå‰å †
description: äºŒå‰å †
pubDate: 2025-10-10
toc: true
ogImage: true
category: ç®—æ³•
---

**åŸºæœ¬æ¦‚å¿µ**

äºŒå‰å †åœ¨è®¡ç®—æœºç§‘å­¦ä¸­æ˜¯ä¸€ç§éå¸¸è‘—åçš„æ•°æ®ç»“æ„ï¼Œç”±äºå®ƒèƒ½é«˜æ•ˆã€**å¿«é€Ÿçš„æ‰¾å‡ºæœ€å¤§å€¼ã€æœ€å°å€¼**ï¼Œå¸¸å¸¸è¢«ç”¨äºä¼˜å…ˆé˜Ÿåˆ—ã€‚å®ƒä¹Ÿè¢«ç”¨äºè‘—åçš„æ’åºç®—æ³•ä¸­ã€‚

äºŒå‰å †åˆ†ä¸ºä¸¤ç§ï¼š

1. æœ€å°å †ï¼šç‰¹ç‚¹æ˜¯æ¯ä¸ªå­èŠ‚ç‚¹éƒ½å¤§äºç­‰äºçˆ¶èŠ‚ç‚¹ï¼Œå› æ­¤åœ¨æœ€å°å †ä¸­å¯ä»¥å¿«é€Ÿæ‰¾å‡ºæœ€å°å€¼
2. æœ€å¤§å †ï¼šæ¯ä¸ªå­èŠ‚ç‚¹éƒ½å°äºç­‰äºçˆ¶èŠ‚ç‚¹ï¼Œå› æ­¤åœ¨æœ€å¤§å †ä¸­å¯ä»¥å¿«é€Ÿæ‰¾å‡ºæœ€å¤§å€¼

äºŒå‰å †æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€é¢—å®Œå…¨äºŒå‰æ ‘ï¼Œä½†æ˜¯å’Œå‰é¢ä»‹ç»è¿‡çš„äºŒå‰æœç´¢æ ‘åˆæœ‰ä¸€å®šçš„åŒºåˆ«ï¼š

- äºŒå‰æœç´¢æ ‘ï¼šå·¦ä¾§å­èŠ‚ç‚¹æ€»æ˜¯æ¯”çˆ¶èŠ‚ç‚¹å°ï¼Œå³ä¾§å­èŠ‚ç‚¹æ€»æ˜¯æ¯”çˆ¶èŠ‚ç‚¹å¤§

```js
;[4, 2, 7, 1, 3, 6, 5]
```

<img
  src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-05-014953.png"
  alt="image-20250305094952420"
  style="zoom:50%;"
/>

**äºŒå‰å †çš„å­˜å‚¨**

ä»ç„¶ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨äºŒå‰å †ã€‚

å·²çŸ¥ä¸€ä¸ªèŠ‚ç‚¹çš„ç´¢å¼•ä¸‹æ ‡å€¼ indexï¼Œå¯ä»¥æ±‚å‡ºï¼š

1. å·¦å­èŠ‚ç‚¹çš„ä¸‹æ ‡å€¼ï¼š `2 * index + 1`
2. å³å­èŠ‚ç‚¹çš„ä¸‹æ ‡å€¼: `2 * index + 2`
3. çˆ¶èŠ‚ç‚¹çš„ä¸‹æ ‡å€¼ï¼š`Math.floor((index - 1) / 2)`

![image-20250305100323500](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-05-020323.png)

**å®ç°ä»£ç **

```js
// utils.js
const Compare = {
  LESS_THAN: -1,
  BIGGER_THAN: 1,
  EQUALS: 0,
}
function defaultCompare(a, b) {
  if (a === b) return Compare.EQUALS
  return a < b ? Compare.LESS_THAN : Compare.BIGGER_THAN
}

function swap(array, a, b) {
  ;[array[a], array[b]] = [array[b], array[a]]
}

module.exports = {
  defaultCompare,
  swap,
  Compare,
}
```

```js
// heap.js
const { defaultCompare, swap, Compare } = require('./utils.js')
// æœ€å°å †ç±»
class MinHeap {
  /**
   * compareFn - æ¯”è¾ƒæ–¹æ³•
   */
  constructor(compareFn = defaultCompare) {
    this.compareFn = compareFn
    this.heap = [] // ç”¨äºå­˜å‚¨æœ€å°å †æ‰€æœ‰å…ƒç´ 
  }
  // è·å–å·¦å­èŠ‚ç‚¹ä¸‹æ ‡
  getLeftIndex(index) {
    return 2 * index + 1
  }
  // è·å–å³å­èŠ‚ç‚¹ä¸‹æ ‡
  getRightIndex(index) {
    return 2 * index + 2
  }
  // è·å–çˆ¶èŠ‚ç‚¹
  getParentIndex(index) {
    if (index === 0) return undefined
    return Math.floor((index - 1) / 2)
  }
  // è·å–å½“å‰æœ€å°å †çš„æœ€å°å€¼
  // æœ€å°å †ä¸­ï¼Œå †é¡¶çš„å…ƒç´ å°±æ˜¯æœ€å°çš„ï¼Œæ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
  findMini() {
    return this.isEmpty() ? undefined : this.heap[0]
  }
  // è¿˜æœ‰ä¸€äº›å·¥å…·æ–¹æ³•
  size() {
    return this.heap.length
  }
  isEmpty() {
    return this.size() <= 0
  }
  clear() {
    this.heap = []
  }
  getAsArray() {
    // å°±æ˜¯è·å–å†…éƒ¨å­˜å‚¨äº†å…ƒç´ çš„æ•°ç»„
    return this.heap
  }
}
```

**æ–°å¢å…ƒç´ **

å½“å‘ä¸€ä¸ªæœ€å°å †æ–°å¢ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œéœ€è¦å¯¹è¯¥å…ƒç´ åš **ä¸Šç§»æ“ä½œ**ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20250305113030743](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-05-033031.png)

```js
insert(value){
  if(value !== null){
    // æ‰§è¡Œæ’å…¥æ“ä½œ

    // è·å–æ–°å…ƒç´ åº”è¯¥æ’å…¥çš„ä½ç½®
    const index = this.heap.length;
    this.heap.push(value);
    // æ¥ä¸‹æ¥å°±éœ€è¦å‘ä¸Šè°ƒæ•´
    this.siftUp(index); // ä¼ å…¥æ–°å…ƒç´ çš„ä¸‹æ ‡
    return true;
  }
  return false;
}

/**
 * index - ä¸€å¼€å§‹å…ƒç´ çš„ä¸‹æ ‡
 */
siftUp(index){
  // å…ˆè·å–çˆ¶èŠ‚ç‚¹çš„ä¸‹æ ‡
  let parent = this.getParentIndex(index);

  // æ¥ä¸‹æ¥å¾ªç¯å’Œçˆ¶èŠ‚ç‚¹åšæ¯”è¾ƒä»¥åŠäº¤æ¢æ“ä½œ
  while(index > 0 &&
        this.compareFn(this.heap[parent], this.heap[index]) === Compare.BIGGER_THAN
     ){
    // ä¸¤ä¸ªèŠ‚ç‚¹éœ€è¦è¿›è¡Œäº¤æ¢
    swap(this.heap, parent, index);
    // æ›´æ–° index çš„å€¼ï¼Œåé¢æ–¹ä¾¿æ ¹æ®æ–°çš„ index å¯»æ‰¾ä¸‹ä¸€ä¸ªçˆ¶èŠ‚ç‚¹
    index = parent;
    // ç»§ç»­å¯»æ‰¾çˆ¶èŠ‚ç‚¹çš„ä¸‹æ ‡
    parent = this.getParentIndex(index);
  }
}
```

**æå–å…ƒç´ **

ä¸€èˆ¬æ¥è®²ï¼Œå½¢æˆä¸€ä¸ªæœ€å¤§æˆ–æœ€å°å †ï¼Œä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è·å–å½“å‰çš„æœ€å€¼ã€‚åœ¨äºŒå‰å †ä¸­è¦è·å–æœ€å€¼çš„æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥ç§»é™¤æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å³å¯ã€‚ä½†æ˜¯å‘¢ï¼Œåˆæ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºç§»é™¤äº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬å°±å¾—é‡æ–°æ„é€ æ–°çš„äºŒå‰å †ï¼Œå°†æ–°çš„æœ€å€¼æ”¾ç½®äºæœ€ä¸Šé¢ã€‚

ğŸ™‹é‚£ä¹ˆè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ç¡®å®šæ–°çš„æœ€å€¼ï¼Œæ”¾ç½®åˆ°æœ€ä¸Šé¢å‘¢ï¼Ÿ

å›ç­”ï¼šä¸€èˆ¬æ¥è®²ï¼Œæ˜¯å°†æœ€åä¸€ä¸ªå…ƒç´ æ”¾åˆ°å¤´éƒ¨

![image-20250305114143670](https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-05-034143.png)

ç„¶åé‡æ–°è¿›è¡Œ **ä¸‹ç§»æ“ä½œ**ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img
  src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-05-035133.png"
  alt="image-20250305115133274"
  style="zoom:30%;"
/>

åœ¨æœ€å°å †çš„ siftDown è¿‡ç¨‹ä¸­ï¼Œ**é€šå¸¸éœ€è¦åŒæ—¶æ¯”è¾ƒå·¦å³å­ç»“ç‚¹å¹¶é€‰æ‹©å…¶ä¸­æ›´å°çš„é‚£ä¸ª**è¿›è¡Œä¸‹ä¸€æ­¥çš„äº¤æ¢å’Œä¸‹æ»¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåªå’Œå·¦å­ç»“ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå¯èƒ½å¿½ç•¥äº†å³å­ç»“ç‚¹æ¯”å·¦å­ç»“ç‚¹æ›´å°çš„æƒ…å†µï¼Œå¯¼è‡´å †åºç ´åã€‚

```js
// ä»å †é¡¶æå–æœ€å€¼
extract(){
  if(this.isEmpty()) return undefined;
  // å¦‚æœæ•´ä¸ªäºŒå‰å †åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥å¼¹å‡ºï¼Œä¸éœ€è¦åšä¸‹ç§»å¤„ç†
  if(this.size() === 1) return this.heap.shift();

  // ä¸‹é¢è¯´æ˜ä¸æ­¢ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆéœ€è¦åšä¸‹ç§»å¤„ç†
  const removedValue = this.heap[0]; // å…ˆå­˜å‚¨æœ€å€¼
  this.heap[0] = this.heap.pop(); // å°†æœ€åä¸€ä¸ªå…ƒç´ å¼¹å‡ºï¼Œä½œä¸ºæ–°çš„å †é¡¶å…ƒç´ 
  this.siftDown(0);

  // å‘å¤–ç•Œè¿”å›ä¹‹å‰ç¼“å­˜çš„æœ€å€¼
  return removedValue;
}
```

```js
siftDown(index){
  let element = index;
  // å…ˆè·å–å·¦å³å­èŠ‚ç‚¹çš„ä¸‹æ ‡
  const left = this.getLeftIndex(index); // å·¦å­èŠ‚ç‚¹ä¸‹æ ‡
  const right = this.getRightIndex(index); // å³å­èŠ‚ç‚¹ä¸‹æ ‡
  const size = this.size();

  // å…ˆæ¯”è¾ƒå·¦è¾¹çš„å­èŠ‚ç‚¹ï¼Œå½“å‰ element å¯¹åº”çš„èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹
  if(left < size &&
     this.compareFn(this.heap[element], this.heap[left]) === Compare.BIGGER_THAN
  ){
    // éœ€è¦è®°å½•æ–°çš„å·¦å­èŠ‚ç‚¹ä¸‹æ ‡
    element = left;
  }

  // ç„¶åå†æ¯”è¾ƒå³å­èŠ‚ç‚¹ï¼Œå½“å‰ element å¯¹åº”çš„èŠ‚ç‚¹å¯èƒ½æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯å·¦å­èŠ‚ç‚¹
  if(right < size &&
     this.compareFn(this.heap[element], this.heap[right]) === Compare.BIGGER_THAN
  ){
    // éœ€è¦è®°å½•æ–°çš„å³å­èŠ‚ç‚¹ä¸‹æ ‡
    element = right;
  }

  // å¦‚æœå‘ç°æ¯”çˆ¶èŠ‚ç‚¹æ›´å°çš„å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±éœ€è¦äº¤æ¢å¹¶ä¸”é€’å½’å‘ä¸‹ç»§ç»­è°ƒæ•´
  if(element !== index){
    swap(this.heap, index, element);
    this.siftDown(element); // ç»§ç»­å¾€ä¸‹è°ƒæ•´
  }
}
```

**å †åŒ–å¤„ç†**

æ‰€è°“å †åŒ–ï¼ŒæŒ‡çš„å°±æ˜¯å°† **æ— åºçš„æ•°ç»„** è°ƒæ•´æˆä¸€ä¸ªæ»¡è¶³æœ€å°å †ï¼ˆæˆ–è€…æœ€å¤§å †ï¼‰çš„å †ç»“æ„ã€‚

åœ¨è¿›è¡Œè°ƒæ•´çš„æ—¶å€™ï¼Œå¶å­èŠ‚ç‚¹æ˜¯ä¸éœ€è¦è°ƒæ•´çš„ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰å­èŠ‚ç‚¹ã€‚å› æ­¤æˆ‘ä»¬åœ¨è°ƒæ•´çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæ‰¾åˆ°éå¶å­èŠ‚ç‚¹ã€‚

å¯»æ‰¾éå¶å­èŠ‚ç‚¹èŒƒå›´ï¼šä» 0 åˆ° `Math.floor(size / 2) - 1`

<img
  src="https://xiejie-typora.oss-cn-chengdu.aliyuncs.com/2025-03-26-084558.png"
  alt="image-20250326164558192"
  style="zoom:30%;"
/>

éå¶å­èŠ‚ç‚¹ï¼šä» 0 åˆ° `Math.floor(5 / 2) - 1` = ä» 0 åˆ° 1

```js
/**
 * array - æ— åºçš„æ•°ç»„
 */
heapify(array){
  if(array){
    // å¦‚æœä¼ å…¥äº†æ•°ç»„ï¼Œå…ˆå¤åˆ¶ä¸€ä»½ç»™å½“å‰å †ï¼Œé¿å…ä¿®æ”¹åŸæ¥çš„æ•°ç»„
    this.heap = [...array];
  }

  // æ¥ä¸‹æ¥å°±éœ€è¦æ‰¾éå¶å­èŠ‚ç‚¹æœ€å¤§çš„ç´¢å¼•å€¼
  const maxIndex = Math.floor(this.size() / 2) - 1;
  // æ¥ä¸‹æ¥å°±éœ€è¦å¯¹æ¯ä¸€ä¸ªéå¶å­èŠ‚ç‚¹è¿›è¡Œå‘ä¸‹è°ƒæ•´
  // è¿™é‡Œä»æœ€åä¸€ä¸ªéå¶å­èŠ‚ç‚¹ä¸€ç›´è°ƒæ•´åˆ°æ ¹èŠ‚ç‚¹
  for(let i = maxIndex; i >= 0; i--){
    this.siftDown(i);
  }

  return this.heap;

}
```

**æœ€å¤§å †**

```js
// utils.js
function reverseCompare(compareFn) {
  return (a, b) => compareFn(b, a)
}
```

```js
class MaxHeap extends MinHeap {
  constructor(compareFn = defaultCompare) {
    super(compareFn)
    this.compareFn = reverseCompare(compareFn)
  }
}
```

**Reactä¸­çš„æœ€å°å †**

åœ¨ React ä¸­ï¼Œå®é™…ä¸Šå°±åˆ©ç”¨äº†æœ€å°å †æ¥ç®¡ç† Scheduler å†…éƒ¨çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚

```ts
// ä¸¤ä¸ªä»»åŠ¡é˜Ÿåˆ—
var taskQueue: Array<Task> = []
var timerQueue: Array<Task> = []

push(timerQueue, newTask) // åƒæ•°ç»„ä¸­æ¨å…¥ä¸€ä¸ªä»»åŠ¡
pop(timerQueue) // ä»æ•°ç»„ä¸­å¼¹å‡ºä¸€ä¸ªä»»åŠ¡
timer = peek(timerQueue) // ä»æ•°ç»„ä¸­è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡
```

æœ€å°å †å¯¹åº”çš„æºç åœ¨ SchedulerMinHeap.js æ–‡ä»¶ä¸­ï¼Œæ€»å…±æœ‰ 6 ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­å‘å¤–æš´éœ²äº† 3 ä¸ªæ–¹æ³•

- pushï¼šå‘æœ€å°å †æ¨å…¥ä¸€ä¸ªå…ƒç´ ã€‚å› ä¸ºä½¿ç”¨çš„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åœ¨æ¨å…¥ä»»åŠ¡çš„æ—¶å€™ï¼Œé¦–å…ˆè¯¥ä»»åŠ¡æ˜¯è¢«æ¨å…¥åˆ°æ•°ç»„çš„æœ€åä¸€é¡¹ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªè°ƒæ•´ï¼Œæˆ‘ä»¬éœ€è¦å‘ä¸Šè°ƒæ•´ï¼ŒæŠŠè¿™ä¸ªä»»åŠ¡è°ƒæ•´åˆ°åˆé€‚çš„ä½ç½®ã€‚

  ```ts
  push(timerQueue, newTask)
  export function push(heap, node) {
    const index = heap.length
    // æ¨å…¥åˆ°æ•°ç»„çš„æœ€åä¸€ä½
    heap.push(node)
    // å‘ä¸Šè°ƒæ•´ï¼Œè°ƒæ•´åˆ°åˆé€‚çš„ä½ç½®
    siftUp(heap, node, index)
  }
  ```

- popï¼šä»ä»»åŠ¡å †é‡Œé¢å¼¹å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€è¯¥ä»»åŠ¡å·²ç»æ²¡æœ‰åœ¨é˜Ÿåˆ—é‡Œé¢äº†ã€‚

  ```ts
  pop(taskQueue)
  export function pop(heap) {
    if (heap.length === 0) {
      return null
    }
    // è·å–æ•°ç»„çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆä¸€å®šæ˜¯æœ€å°çš„ï¼‰
    const first = heap[0]
    // æ‹¿åˆ°æ•°ç»„çš„æœ€åä¸€ä¸ª
    const last = heap.pop()
    if (last !== first) {
      // å°†æœ€åä¸€ä¸ªä»»åŠ¡æ”¾åˆ°ç¬¬ä¸€ä¸ª
      heap[0] = last
      // æ¥ä¸‹æ¥å‘ä¸‹è°ƒæ•´
      siftDown(heap, last, 0)
    }
    return first
  }
  ```

- peekï¼šå–å‡ºå †é¡¶çš„ä»»åŠ¡ï¼Œå †é¡¶ä¸€å®šæ˜¯æœ€å°çš„ã€‚è¿™ä¸ªæ–¹æ³•æå…¶çš„ç®€å•

  ```ts
  peek(timerQueue)
  export function peek(heap) {
    // è¿”å›è¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    return heap.length === 0 ? null : heap[0]
  }
  ```

æ²¡æœ‰æš´éœ²çš„æ˜¯ï¼š

- siftUpï¼šå‘ä¸Šè°ƒæ•´
- siftDownï¼šå‘ä¸‹è°ƒæ•´
- compareï¼šè¿™æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œå°±æ˜¯ä¸¤ä¸ªå…ƒç´ åšæ¯”è¾ƒçš„

> è¿™ 3 ä¸ªæ–¹æ³•å¯ä»¥å‚é˜… [React ä¸­ Scheduler ç›¸å…³æºç ](https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerMinHeap.js)ã€‚

---

-EOF-
